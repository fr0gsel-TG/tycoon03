<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoreTycoon: IT Empire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    // ==================== –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ====================
        const TelegramIntegration = {
            userId: null,
            apiUrl: window.location.origin.includes('localhost') 
                ? 'http://localhost:3000/api' 
                : window.location.origin + '/api',
            
            init() {
                // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                const urlParams = new URLSearchParams(window.location.search);
                this.userId = urlParams.get('tg');
                
                if (this.userId) {
                    console.log('Telegram user detected:', this.userId);
                    this.loadFromServer();
                    
                    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                    setInterval(() => this.autoSave(), 30000);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    window.addEventListener('beforeunload', () => this.saveToServer());
                }
            },
            
            async loadFromServer() {
                try {
                    const response = await fetch(`${this.apiUrl}/load/${this.userId}`);
                    const data = await response.json();
                    
                    if (data.success && data.gameData) {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                        Object.assign(GameState, data.gameData.gameState || {});
                        Object.assign(UNLOCKED_ITEMS, data.gameData.unlockedItems || {});
                        Object.assign(QuestSystem, data.gameData.quests || {});
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ NPC
                        GameState.objects = data.gameData.objects || [];
                        GameState.npcs = data.gameData.npcs || [];
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                        if (data.gameData.camera) {
                            camera.x = data.gameData.camera.x || camera.x;
                            camera.y = data.gameData.camera.y || camera.y;
                        }
                        
                        SaveSystem.restoreWorkstationLinks();
                        
                        showNotification('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –æ–±–ª–∞–∫–∞!', 'success');
                        updateUI();
                        updateQuestUI();
                    }
                } catch (error) {
                    console.error('Failed to load from server:', error);
                }
            },
            
            async saveToServer() {
                if (!this.userId) return;
                
                const saveData = {
                    version: SaveSystem.CURRENT_VERSION,
                    timestamp: Date.now(),
                    gameState: {
                        tsp: GameState.tsp,
                        clickPower: GameState.clickPower,
                        autoClicker: GameState.autoClicker,
                        gridSize: GameState.gridSize,
                        xp: GameState.xp,
                        reputation: GameState.reputation,
                        level: GameState.level,
                        techDebt: GameState.techDebt,
                        bugs: GameState.bugs
                    },
                    objects: GameState.objects,
                    npcs: GameState.npcs.map(npc => ({
                        ...npc,
                        currentWorkstation: npc.currentWorkstation ? {
                            x: npc.currentWorkstation.x,
                            y: npc.currentWorkstation.y,
                            id: npc.currentWorkstation.id
                        } : null
                    })),
                    unlockedItems: UNLOCKED_ITEMS,
                    quests: {
                        activeQuests: QuestSystem.activeQuests,
                        completedQuests: QuestSystem.completedQuests,
                        failedQuests: QuestSystem.failedQuests,
                        stats: QuestSystem.stats
                    },
                    camera: {
                        x: camera.x,
                        y: camera.y
                    }
                };
                
                const stats = {
                    totalEarned: GameState.tsp,
                    reputation: GameState.reputation,
                    playTime: Math.floor((Date.now() - (GameState.startTime || Date.now())) / 1000 / 60) // –≤ –º–∏–Ω—É—Ç–∞—Ö
                };
                
                try {
                    const response = await fetch(`${this.apiUrl}/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            gameData: saveData,
                            stats: stats
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log('Game saved to cloud:', result.saveId);
                        return true;
                    }
                } catch (error) {
                    console.error('Failed to save to server:', error);
                }
                
                return false;
            },
            
            async autoSave() {
                const saved = await this.saveToServer();
                if (saved) {
                    const notification = document.createElement('div');
                    notification.className = 'save-notification';
                    notification.textContent = 'üîÑ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    notification.style.background = 'rgba(59, 130, 246, 0.9)';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 2000);
                }
            }
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º SaveSystem –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–ª–∞–∫–æ–º
        SaveSystem.save = function() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const localSaved = this._localSave();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω Telegram
            if (TelegramIntegration.userId) {
                TelegramIntegration.saveToServer();
            }
            
            return localSaved;
        };

        SaveSystem._localSave = function() {
            // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage
            try {
                const saveData = {
                    version: this.CURRENT_VERSION,
                    timestamp: Date.now(),
                    gameState: {
                        tsp: GameState.tsp,
                        clickPower: GameState.clickPower,
                        autoClicker: GameState.autoClicker,
                        gridSize: GameState.gridSize,
                        xp: GameState.xp,
                        reputation: GameState.reputation,
                        level: GameState.level,
                        techDebt: GameState.techDebt,
                        bugs: GameState.bugs
                    },
                    objects: GameState.objects,
                    npcs: GameState.npcs.map(npc => ({
                        ...npc,
                        currentWorkstation: npc.currentWorkstation ? {
                            x: npc.currentWorkstation.x,
                            y: npc.currentWorkstation.y,
                            id: npc.currentWorkstation.id
                        } : null
                    })),
                    unlockedItems: UNLOCKED_ITEMS,
                    quests: {
                        activeQuests: QuestSystem.activeQuests,
                        completedQuests: QuestSystem.completedQuests,
                        failedQuests: QuestSystem.failedQuests,
                        stats: QuestSystem.stats
                    },
                    camera: {
                        x: camera.x,
                        y: camera.y
                    }
                };
                
                localStorage.setItem(this.SAVE_KEY, JSON.stringify(saveData));
                
                this.showSaveNotification();
                console.log('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ (v' + this.CURRENT_VERSION + ')');
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                return false;
            }
        };
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }
        canvas { display: block; }
        
        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        
        #loading-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .logo-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 40px;
        }
        
        #game-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
            animation: logoPulse 3s ease-in-out infinite;
        }
        
        @keyframes logoPulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
        }
        
        .loading-text {
            color: #ffffff;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }
        
        .loading-subtext {
            color: #94a3b8;
            font-size: 16px;
            margin-bottom: 40px;
            text-align: center;
            max-width: 500px;
        }
        
        .progress-container {
            width: 300px;
            height: 6px;
            background-color: #1e293b;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            color: #cbd5e1;
            font-size: 14px;
            text-align: center;
        }
        
        .loading-tips {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #64748b;
            font-size: 14px;
            padding: 0 20px;
            opacity: 0.8;
        }
        
        .tip {
            display: none;
            animation: fadeInOut 6s infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
        
        .tip:nth-child(1) { animation-delay: 0s; }
        .tip:nth-child(2) { animation-delay: 6s; }
        .tip:nth-child(3) { animation-delay: 12s; }
        
        .ui-panel {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #3b82f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }
        
        .floating-text {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            text-shadow: 2px 2px 0 #000;
            -webkit-text-stroke: 1px rgba(0,0,0,0.5);
        }

        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            20% { opacity: 1; transform: translateY(0) scale(1.1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); }
        }

        .btn-pressable {
            transition: all 0.1s;
            border-bottom-width: 4px;
        }
        .btn-pressable:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-top: 2px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–¥–∞–Ω–∏–π */
        .quest-notification {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #3b82f6;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(4px);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .quest-icon {
            font-size: 1.2rem;
        }

        .quest-title {
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }

        .quest-desc {
            color: #cbd5e1;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .quest-timer {
            margin-top: 6px;
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 4px;
            color: #fca5a5;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
        }

        /* –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .hover-glow {
            transition: all 0.2s ease;
        }
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
        .save-indicator {
            animation: savePulse 0.5s ease-in-out;
        }

        @keyframes savePulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-screen">
        <div class="logo-container">
            <img id="game-logo" src="logo_game.png" alt="StoreTycoon Logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 200 200\"><rect width=\"200\" height=\"200\" fill=\"%230f172a\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"30\" fill=\"%233b82f6\" text-anchor=\"middle\" dy=\".3em\">STORE TYCOON</text></svg>'">
        </div>
        
        <div class="loading-text" id="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ StoreTycoon...</div>
        <div class="loading-subtext" id="loading-submessage">–°—Ç—Ä–æ–∏–º –≤–∞—à IT-–∏–º–ø–µ—Ä–∏—é</div>
        
        <div class="progress-container">
            <div class="progress-bar" id="loading-progress"></div>
        </div>
        <div class="progress-text" id="loading-percentage">0%</div>
        
        <div class="loading-tips">
            <div class="tip">üí° –°–æ–≤–µ—Ç: –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∏–≥—Ä—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∫–Ω–æ–ø–∫–æ–π üíæ</div>
            <div class="tip">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –õ–ö–ú - —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å, –ü–ö–ú - –æ—Ç–º–µ–Ω–∞, ESC - –º–µ–Ω—é</div>
            <div class="tip">üöÄ –†–∞—Å—à–∏—Ä—è–π—Ç–µ—Å—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ: —Å—Ç–æ–ª ‚Üí —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Üí —Å–µ—Ä–≤–µ—Ä</div>
        </div>
    </div>

    <!-- HUD (—Å–∫—Ä—ã—Ç –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏) -->
    <div id="game-hud" class="hidden">
        <div class="absolute top-0 left-0 w-full p-4 pointer-events-none flex justify-between items-start z-10">
            <div class="flex flex-col gap-2 pointer-events-auto">
                <div class="bg-slate-900/90 text-white px-5 py-3 rounded-2xl border border-green-500/50 shadow-xl flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-xs font-bold text-slate-900">$</div>
                    <div>
                        <div class="text-xs text-green-400 font-bold uppercase tracking-wider">–ö–∞–ø–∏—Ç–∞–ª</div>
                        <div id="score-tsp" class="text-2xl font-mono font-bold leading-none">100</div>
                    </div>
                </div>
                <div class="bg-slate-900/90 text-white px-5 py-3 rounded-2xl border border-blue-500/50 shadow-xl">
                    <div class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1">–î–æ—Ö–æ–¥/—Å–µ–∫</div>
                    <div id="income-per-sec" class="text-xl font-mono font-bold leading-none">0</div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <button id="save-game" class="btn-pressable bg-slate-800 hover:bg-slate-700 border-slate-600 text-white px-3 py-2 rounded-xl text-sm font-semibold shadow-lg flex items-center gap-2 pointer-events-auto" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É">
                    üíæ
                </button>
                <div class="bg-slate-900/80 backdrop-blur text-blue-200 px-4 py-2 rounded-xl border border-blue-500/30 text-sm font-semibold shadow-lg">
                    <span>üè¢</span> –ì–∞—Ä–∞–∂ (Lvl <span id="player-level">1</span>)
                </div>
                <div class="bg-slate-900/80 backdrop-blur text-purple-200 px-4 py-2 rounded-xl border border-purple-500/30 text-sm font-semibold shadow-lg">
                    <span>‚≠ê</span> –†–µ–ø—É—Ç–∞—Ü–∏—è: <span id="reputation">0</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="absolute bottom-8 left-0 w-full px-4 pointer-events-auto z-20 flex justify-center gap-4">
            <button id="work-btn" class="btn-pressable flex-1 max-w-sm bg-blue-600 hover:bg-blue-500 border-blue-800 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 text-xl">
                <span>üíª</span> –ü–∏—Å–∞—Ç—å –∫–æ–¥
            </button>
            <button id="assign-workers" class="btn-pressable w-20 bg-emerald-600 hover:bg-emerald-500 border-emerald-800 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center text-2xl" title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É">
                üë®‚Äçüíº
            </button>
            <button id="quest-toggle" class="btn-pressable w-20 bg-purple-600 hover:bg-purple-500 border-purple-800 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center text-2xl">
                üéØ
            </button>
            <button id="shop-toggle" class="btn-pressable w-20 bg-amber-500 hover:bg-amber-400 border-amber-700 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center text-2xl">
                üõí
            </button>
        </div>

        <!-- Shop Modal -->
        <div id="shop-panel" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 max-h-[70vh] ui-panel rounded-2xl flex flex-col pointer-events-auto z-30 shadow-2xl overflow-hidden transition-all">
            <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg">IT –ú–∞–≥–∞–∑–∏–Ω</h3>
                <button id="close-shop" class="text-slate-400 hover:text-white transition-colors">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-3" id="shop-items"></div>
            <div class="p-3 border-t border-slate-700">
                <div class="text-xs text-slate-400 text-center">
                    –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ç–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                </div>
            </div>
        </div>

        <!-- Placement Mode Indicator -->
        <div id="placement-mode" class="hidden absolute top-24 left-1/2 transform -translate-x-1/2 bg-blue-600/90 text-white px-4 py-2 rounded-xl border border-blue-400 text-sm font-semibold shadow-lg pointer-events-none z-40">
            <div class="flex items-center gap-2">
                <span>üìç</span>
                <span>–†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</span>
                <span id="placing-item-name" class="font-bold"></span>
                <button id="cancel-placement" class="ml-2 text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">‚úï –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- Quest Panel -->
        <div id="quest-panel" class="hidden absolute top-24 left-4 w-80 ui-panel rounded-2xl p-4 pointer-events-auto z-30">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-lg flex items-center gap-2">
                    <span>üéØ</span> IT –ó–∞–¥–∞–Ω–∏—è
                </h3>
                <div class="text-xs text-blue-400">
                    –û–ø—ã—Ç: <span id="player-xp">0</span>
                </div>
            </div>
            
            <div class="text-sm text-slate-300 mb-3">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:</div>
            <div id="active-quests" class="space-y-3 mb-6 max-h-60 overflow-y-auto"></div>
            
            <div class="border-t border-slate-700 pt-4">
                <div class="text-sm text-slate-300 mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:</div>
                <div id="available-quests" class="space-y-2"></div>
            </div>
        </div>

        <!-- Tech Debt Bar -->
        <div id="tech-debt-bar" class="hidden absolute bottom-32 left-1/2 transform -translate-x-1/2 w-64 bg-slate-800/80 rounded-full h-6 overflow-hidden border border-slate-600 pointer-events-none z-40">
            <div id="tech-debt-fill" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 transition-all duration-500" style="width: 0%"></div>
            <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">
                üêõ –¢–µ—Ö–¥–æ–ª–≥: <span id="debt-value">0</span>%
            </div>
        </div>

        <!-- Notification Center -->
        <div id="notification-center" class="absolute top-4 right-4 w-80 space-y-2 pointer-events-none z-40"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // ==================== –°–ò–°–¢–ï–ú–ê –ó–ê–ì–†–£–ó–ö–ò ====================
        const LoadingSystem = {
            progress: 0,
            totalSteps: 7, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
            currentStep: 0,
            isLoading: true,
            
            steps: [
                { message: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...", submessage: "–ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" },
                { message: "–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∏...", submessage: "–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤–æ–∫—Å–µ–ª—å-—Ä–µ–Ω–¥–µ—Ä–µ—Ä" },
                { message: "–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...", submessage: "–°–æ–∑–¥–∞–µ–º –º–µ–±–µ–ª—å –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" },
                { message: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NPC...", submessage: "–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤" },
                { message: "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–µ—Å—Ç–æ–≤...", submessage: "–°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –∏ —Å–∏—Å—Ç–µ–º—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞" },
                { message: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π...", submessage: "–ò—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã" },
                { message: "–ó–∞–ø—É—Å–∫ –º–∏—Ä–∞...", submessage: "–°–æ–∑–¥–∞–µ–º –≤–∞—à –æ—Ñ–∏—Å" }
            ],
            
            init() {
                this.showLoadingScreen();
                this.startLoading();
            },
            
            showLoadingScreen() {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading-screen').style.display = 'flex';
                document.getElementById('game-hud').classList.add('hidden');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–æ–≤–µ—Ç
                document.querySelectorAll('.tip').forEach((tip, index) => {
                    tip.style.display = 'block';
                });
            },
            
            startLoading() {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
                this.loadLogo();
                
                // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
                this.nextStep();
            },
            
            loadLogo() {
                const logo = document.getElementById('game-logo');
                const fallbackLogo = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect width="200" height="200" fill="%230f172a"/><text x="50%" y="50%" font-family="Arial" font-size="30" fill="%233b82f6" text-anchor="middle" dy=".3em">STORE TYCOON</text></svg>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ª–æ–≥–æ—Ç–∏–ø–∞
                logo.onload = () => {
                    console.log('–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    this.updateProgress(10);
                };
                
                logo.onerror = () => {
                    console.log('–õ–æ–≥–æ—Ç–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É');
                    logo.src = fallbackLogo;
                    this.updateProgress(10);
                };
                
                // –ï—Å–ª–∏ –ª–æ–≥–æ—Ç–∏–ø —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                if (logo.complete) {
                    this.updateProgress(10);
                }
            },
            
            nextStep() {
                if (this.currentStep >= this.totalSteps) {
                    this.completeLoading();
                    return;
                }
                
                const step = this.steps[this.currentStep];
                document.getElementById('loading-message').textContent = step.message;
                document.getElementById('loading-submessage').textContent = step.submessage;
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                setTimeout(() => {
                    const stepProgress = ((this.currentStep + 1) / this.totalSteps) * 100;
                    this.updateProgress(stepProgress);
                    this.currentStep++;
                    this.nextStep();
                }, 300 + Math.random() * 400); // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
            },
            
            updateProgress(percent) {
                this.progress = Math.min(100, percent);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                const progressBar = document.getElementById('loading-progress');
                const percentageText = document.getElementById('loading-percentage');
                
                progressBar.style.width = `${this.progress}%`;
                percentageText.textContent = `${Math.round(this.progress)}%`;
                
                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(this.progress)}%`);
            },
            
            completeLoading() {
                // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                this.updateProgress(100);
                
                setTimeout(() => {
                    // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    const loadingScreen = document.getElementById('loading-screen');
                    loadingScreen.classList.add('fade-out');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        document.getElementById('game-hud').classList.remove('hidden');
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
                        this.startGame();
                    }, 800);
                }, 500);
            },
            
            startGame() {
                this.isLoading = false;
                console.log('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º...');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                GameInit.init();
            }
        };

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ====================
        const GameInit = {
            init() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã –∏–≥—Ä—ã
                this.initCanvas();
                this.initGameSystems();
                this.initEventListeners();
                this.startGameLoop();
            },
            
            initCanvas() {
                resize();
                console.log('Canvas –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            },
            
            initGameSystems() {
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                if (SaveSystem.load()) {
                    showNotification('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!', 'success');
                } else {
                    // –ù–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
                    GameState.tsp = 150;
                    
                    setTimeout(() => {
                        QuestSystem.startQuest('intro');
                        showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ IT —Ç–∞–π–∫—É–Ω! –ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.', 'quest');
                        showNotification('üí° –°–æ–≤–µ—Ç: –ö—É–ø–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª –≤ –º–∞–≥–∞–∑–∏–Ω–µ (üõí)', 'info');
                    }, 1000);
                }
                
                // –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                SaveSystem.enableAutoSave(30000);
                
                updateUI();
                render();
                
                setTimeout(() => {
                    showNotification('üí° –°–æ–≤–µ—Ç: –í—ã –º–æ–∂–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É üíæ', 'info');
                }, 5000);
            },
            
            initEventListeners() {
                // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ
                console.log('Event listeners –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
            },
            
            startGameLoop() {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Ö–æ–¥
                setInterval(() => {
                    let totalIncome = 0;
                    
                    GameState.objects.forEach(obj => {
                        const item = ITEM_TYPES[obj.id];
                        if (item.income) {
                            totalIncome += item.income;
                        }
                    });
                    
                    GameState.npcs.forEach(npc => {
                        if (npc.state === 'working' && npc.currentWorkstation) {
                            const baseIncome = npc.id === 'employee_dev' ? 30 : 60;
                            const efficiency = WorkSystem.getWorkEfficiency(npc, npc.currentWorkstation);
                            totalIncome += baseIncome * efficiency;
                            
                            if (Math.random() < 0.1) {
                                const iso = toIso(npc.x, npc.y);
                                spawnFloatingText(
                                    `+$${Math.floor(baseIncome * efficiency)}`, 
                                    iso.x + camera.x, 
                                    iso.y + camera.y - 50, 
                                    '#22c55e'
                                );
                            }
                        }
                    });
                    
                    if (totalIncome > 0) {
                        GameState.tsp += totalIncome;
                        GameState.techDebt = Math.min(100, GameState.techDebt + 0.1);
                        updateUI();
                        if (Math.random() < 0.01) SaveSystem.save();
                    }
                }, 1000);

                // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
                setInterval(() => {
                    updateNPCs();
                    updateParticles();
                    generateBug();
                    updateTechDebtUI();
                }, 16);
                
                console.log('–ò–≥—Ä–æ–≤—ã–µ —Ü–∏–∫–ª—ã –∑–∞–ø—É—â–µ–Ω—ã');
            }
        };

        // ==================== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î –ò–ì–†–´ ====================
        // (–í–µ—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ –∏–≥—Ä—ã –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å, –Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ LoadingSystem)
        
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            tileSize: 64,
            colors: {
                floor: '#1e293b',
                floorHighlight: '#334155',
                gridStroke: '#0f172a',
                placementValid: 'rgba(34, 197, 94, 0.3)',
                placementInvalid: 'rgba(239, 68, 68, 0.3)'
            }
        };

        // ==================== –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø ====================
const SaveSystem = {
    SAVE_KEY: 'storetycoon_it_save',
    CURRENT_VERSION: '1.1', // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    
    save() {
        try {
            const saveData = {
                version: this.CURRENT_VERSION, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
                timestamp: Date.now(),
                gameState: {
                    tsp: GameState.tsp,
                    clickPower: GameState.clickPower,
                    autoClicker: GameState.autoClicker,
                    gridSize: GameState.gridSize,
                    xp: GameState.xp,
                    reputation: GameState.reputation,
                    level: GameState.level,
                    techDebt: GameState.techDebt,
                    bugs: GameState.bugs
                },
                objects: GameState.objects,
                npcs: GameState.npcs.map(npc => ({
                    ...npc,
                    currentWorkstation: npc.currentWorkstation ? {
                        x: npc.currentWorkstation.x,
                        y: npc.currentWorkstation.y,
                        id: npc.currentWorkstation.id
                    } : null
                })),
                unlockedItems: UNLOCKED_ITEMS,
                quests: {
                    activeQuests: QuestSystem.activeQuests,
                    completedQuests: QuestSystem.completedQuests,
                    failedQuests: QuestSystem.failedQuests,
                    stats: QuestSystem.stats
                },
                camera: {
                    x: camera.x,
                    y: camera.y
                }
            };
            
            localStorage.setItem(this.SAVE_KEY, JSON.stringify(saveData));
            this.showSaveNotification();
            console.log('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (v' + this.CURRENT_VERSION + '):', saveData);
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            return false;
        }
    },
    
    load() {
        try {
            const saved = localStorage.getItem(this.SAVE_KEY);
            if (!saved) {
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É');
                this.initializeNewGame();
                return false;
            }
            
            const saveData = JSON.parse(saved);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (saveData.version !== this.CURRENT_VERSION) {
                console.log(`–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –≤–µ—Ä—Å–∏–∏ ${saveData.version || '1.0'} –¥–æ ${this.CURRENT_VERSION}`);
                saveData = this.migrateSaveData(saveData);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            Object.assign(GameState, saveData.gameState);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            if (saveData.unlockedItems) {
                Object.assign(UNLOCKED_ITEMS, saveData.unlockedItems);
            }
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –±–∞–∑–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã (–¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤)
            this.ensureBaseItemsUnlocked();
            
            Object.assign(QuestSystem, saveData.quests);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
            if (saveData.camera) {
                camera.x = saveData.camera.x || camera.x;
                camera.y = saveData.camera.y || camera.y;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ NPC
            GameState.objects = saveData.objects || [];
            GameState.npcs = saveData.npcs || [];
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑–∏ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç
            this.restoreWorkstationLinks();
            
            showNotification('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
            console.log('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (v' + saveData.version + '):', saveData);
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É.', 'error');
            this.initializeNewGame();
            return false;
        }
    },
    
    // –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    migrateSaveData(saveData) {
        const version = saveData.version || '1.0';
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ 1.0 –Ω–∞ 1.1
        if (version === '1.0') {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å 1.0 –Ω–∞ 1.1');
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            const baseItems = ['desk_wood', 'office_chair', 'pc_setup', 'plant'];
            baseItems.forEach(item => {
                if (!saveData.unlockedItems) saveData.unlockedItems = {};
                saveData.unlockedItems[item] = true;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if (!saveData.gameState.techDebt) saveData.gameState.techDebt = 0;
            if (!saveData.gameState.bugs) saveData.gameState.bugs = [];
            
            saveData.version = '1.1';
        }
        
        // –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –±—É–¥—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
        // if (version === '1.1') {
        //     // –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ 1.2 –∏ —Ç.–¥.
        //     saveData.version = '1.2';
        // }
        
        return saveData;
    },
    
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –±–∞–∑–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
    ensureBaseItemsUnlocked() {
        const baseItems = [
            'desk_wood', 'office_chair', 'pc_setup', 'plant',
            'employee_dev', 'coffee_machine', 'employee_manager',
            'server_rack', 'whiteboard'
        ];
        
        baseItems.forEach(item => {
            UNLOCKED_ITEMS[item] = true;
        });
    },
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã
    initializeNewGame() {
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        GameState.tsp = 100;
        GameState.clickPower = 1;
        GameState.autoClicker = 0;
        GameState.objects = [];
        GameState.npcs = [];
        GameState.xp = 0;
        GameState.reputation = 0;
        GameState.level = 1;
        GameState.techDebt = 0;
        GameState.bugs = [];
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        Object.keys(ITEM_TYPES).forEach(key => {
            UNLOCKED_ITEMS[key] = true;
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–≤–µ—Å—Ç—ã
        QuestSystem.activeQuests = [];
        QuestSystem.completedQuests = [];
        QuestSystem.failedQuests = [];
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
        setTimeout(() => {
            QuestSystem.startQuest('intro');
            showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ IT —Ç–∞–π–∫—É–Ω! –ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.', 'quest');
        }, 1000);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
        this.save();
    },
            
            restoreWorkstationLinks() {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ä–∞–±–æ—á–∏–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
                GameState.objects.forEach(obj => {
                    // –î–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π, –≥–¥–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ ITEM_TYPES
                    if (obj.id === 'pc_setup' && !obj.hasOwnProperty('isOccupied')) {
                        obj.isOccupied = false;
                        obj.currentWorker = null;
                    }
                });
                
                GameState.npcs.forEach(npc => {
                    if (npc.currentWorkstation) {
                        // –ù–∞—Ö–æ–¥–∏–º —Ä–∞–±–æ—á–∏–π —Å—Ç–∞–Ω–æ–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                        const workstation = GameState.objects.find(obj => 
                            obj.x === npc.currentWorkstation.x && 
                            obj.y === npc.currentWorkstation.y &&
                            obj.id === 'pc_setup'
                        );
                        if (workstation) {
                            workstation.isOccupied = true;
                            workstation.currentWorker = npc;
                            npc.currentWorkstation = workstation;
                        }
                    }
                });
            },
            
            delete() {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                    localStorage.removeItem(this.SAVE_KEY);
                    showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'info');
                    location.reload();
                }
            },
            
            exportSave() {
                const saveData = localStorage.getItem(this.SAVE_KEY);
                if (saveData) {
                    const blob = new Blob([saveData], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'store_tycoon_save.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                }
            },
            
            importSave() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const saveData = JSON.parse(event.target.result);
                                localStorage.setItem(this.SAVE_KEY, JSON.stringify(saveData));
                                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–≥—Ä—É.', 'success');
                            } catch (error) {
                                showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            },
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            autoSaveInterval: null,
            
            enableAutoSave(interval = 60000) {
                this.autoSaveInterval = setInterval(() => {
                    this.save();
                    showNotification('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');
                }, interval);
                console.log('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ');
            },
            
            disableAutoSave() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                    this.autoSaveInterval = null;
                    console.log('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
                }
            }
        };

        // ==================== –°–ò–°–¢–ï–ú–ê –†–ê–ó–ú–ï–©–ï–ù–ò–Ø ====================
        const PlacementSystem = {
            isPlacing: false,
            currentItem: null,
            previewX: 0,
            previewY: 0,
            isValidPosition: false,
            
            startPlacement(itemId) {
                const item = ITEM_TYPES[itemId];
                if (!item) return;
                
                this.isPlacing = true;
                this.currentItem = item;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                const placementIndicator = document.getElementById('placement-mode');
                const itemName = document.getElementById('placing-item-name');
                itemName.textContent = item.name;
                placementIndicator.classList.remove('hidden');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –º–∞–≥–∞–∑–∏–Ω
                document.getElementById('shop-panel').classList.add('hidden');
                
                showNotification(`–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ ${item.name} –Ω–∞ —Å–µ—Ç–∫–µ. –õ–ö–ú - –ø–æ—Å—Ç–∞–≤–∏—Ç—å, –ü–ö–ú/ESC - –æ—Ç–º–µ–Ω–∞`, 'info');
            },
            
            updatePreview(x, y) {
                if (!this.isPlacing) return;
                
                this.previewX = Math.floor(x);
                this.previewY = Math.floor(y);
                this.isValidPosition = this.checkPosition(this.previewX, this.previewY);
            },
            
            checkPosition(x, y) {
                if (!this.currentItem) return false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                if (x < 0 || y < 0 || 
                    x >= GameState.gridSize || 
                    y >= GameState.gridSize) {
                    return false;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
                for (const obj of GameState.objects) {
                    const dx = Math.abs(obj.x - x);
                    const dy = Math.abs(obj.y - y);
                    
                    // –†–∞–∑–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤
                    let size = 1;
                    if (obj.id === 'pc_setup') size = 1;
                    if (obj.id === 'server_rack') size = 2;
                    
                    if (dx < size && dy < size) {
                        return false;
                    }
                }
                
                return true;
            },
            
            placeObject(x, y) {
                if (!this.isPlacing || !this.currentItem) return false;
                
                if (!this.checkPosition(x, y)) {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–¥–µ—Å—å!', 'error');
                    return false;
                }
                
                // –í—ã—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                GameState.tsp -= this.currentItem.cost;
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç
                const newObj = {
                    id: this.currentItem.id,
                    x: x,
                    y: y
                };
                
                // –î–ª—è —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (this.currentItem.id === 'pc_setup') {
                    newObj.isOccupied = false;
                    newObj.currentWorker = null;
                }
                
                GameState.objects.push(newObj);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Ö–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (this.currentItem.income > 0) {
                    GameState.autoClicker += this.currentItem.income;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞–Ω–∏–π
                QuestSystem.updateProgress('buy', 1, this.currentItem.id);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–µ—Ö–¥–æ–ª–≥
                GameState.techDebt = Math.min(100, GameState.techDebt + 2);
                
                this.cancelPlacement();
                
                showNotification(`${this.currentItem.name} —Ä–∞–∑–º–µ—â–µ–Ω!`, 'success');
                spawnFloatingText(`- $${this.currentItem.cost}`, 
                    toIso(x, y).x + camera.x, 
                    toIso(x, y).y + camera.y, 
                    '#ef4444');
                
                updateUI();
                updateTechDebtUI();
                SaveSystem.save();
                
                return true;
            },
            
            cancelPlacement() {
                this.isPlacing = false;
                this.currentItem = null;
                document.getElementById('placement-mode').classList.add('hidden');
                showNotification('–†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
            },
            
            drawPreview() {
                if (!this.isPlacing || !this.currentItem) return;
                
                const ts = CONFIG.tileSize;
                const iso = toIso(this.previewX, this.previewY);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–µ–≤—å—é
                let width = 1;
                let depth = 1;
                
                if (this.currentItem.id === 'server_rack') {
                    width = 1.5;
                    depth = 1.5;
                }
                
                // –†–∏—Å—É–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ø—Ä–µ–≤—å—é
                ctx.save();
                ctx.globalAlpha = 0.7;
                
                if (this.isValidPosition) {
                    ctx.fillStyle = CONFIG.colors.placementValid;
                    ctx.strokeStyle = '#22c55e';
                } else {
                    ctx.fillStyle = CONFIG.colors.placementInvalid;
                    ctx.strokeStyle = '#ef4444';
                }
                
                // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                const p0 = toIso(this.previewX, this.previewY);
                const p1 = toIso(this.previewX + width, this.previewY);
                const p2 = toIso(this.previewX + width, this.previewY + depth);
                const p3 = toIso(this.previewX, this.previewY + depth);
                
                ctx.beginPath();
                ctx.moveTo(p0.x, p0.y);
                ctx.lineTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.lineTo(p3.x, p3.y);
                ctx.closePath();
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // –¢–µ–∫—Å—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.currentItem.name, iso.x, iso.y - 20);
                ctx.fillText(`$${this.currentItem.cost}`, iso.x, iso.y - 5);
                
                ctx.restore();
            }
        };

        // ==================== –ò–ì–†–û–í–´–ï –û–ë–™–ï–ö–¢–´ ====================
        const ITEM_TYPES = {
            office_chair: { 
                id: 'office_chair', name: '–ö—Ä–µ—Å–ª–æ Dev', cost: 150, 
                desc: '–£–¥–æ–±—Å—Ç–≤–æ +10%', income: 2,
                renderType: 'chair', 
                colorPrimary: '#eab308', 
                colorSecondary: '#475569',
                size: 1
            },
            desk_wood: { 
                id: 'desk_wood', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—Ç–æ–ª', cost: 50, 
                desc: '–û—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ', income: 0,
                renderType: 'desk', 
                colorPrimary: '#78350f', 
                colorSecondary: '#451a03',
                size: 1
            },
            pc_setup: {
                id: 'pc_setup',
                name: '–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ Dev',
                cost: 500,
                desc: '–ü–ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ +5 –∫–æ–¥/—Å–µ–∫. –ú–æ–∂–Ω–æ –ø–æ—Å–∞–¥–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                income: 5,
                renderType: 'pc',
                colorPrimary: '#94a3b8',
                colorSecondary: '#3b82f6',
                type: 'workstation',
                maxWorkers: 1,
                size: 1
            },
            server_rack: {
                id: 'server_rack', name: '–°–µ—Ä–≤–µ—Ä', cost: 1200,
                desc: '+15 –ö–æ–¥/—Å–µ–∫', income: 15,
                renderType: 'server',
                colorPrimary: '#1e1e1e',
                colorSecondary: '#22c55e',
                size: 2
            },
            plant: {
                id: 'plant', name: '–§–∏–∫—É—Å', cost: 25,
                desc: '–ö—Ä–∞—Å–∏–≤–æ', income: 0,
                renderType: 'plant',
                colorPrimary: '#16a34a',
                colorSecondary: '#78350f',
                size: 1
            },
            employee_dev: {
                id: 'employee_dev',
                name: 'Junior Dev',
                cost: 2500,
                desc: '+30 –∫–æ–¥/—Å–µ–∫, —Ö–æ–¥–∏—Ç –ø–æ –æ—Ñ–∏—Å—É',
                income: 30,
                renderType: 'npc',
                speed: 0.02,
                colorBody: '#3b82f6',
                colorHead: '#fbbf24',
                colorAccent: '#ef4444',
                size: 1
            },
            employee_manager: {
                id: 'employee_manager',
                name: 'Team Lead',
                cost: 5000,
                desc: '+60 –∫–æ–¥/—Å–µ–∫, –±—É—Å—Ç–∏—Ç –∫–æ–º–∞–Ω–¥—É',
                income: 60,
                renderType: 'npc',
                speed: 0.015,
                colorBody: '#8b5cf6',
                colorHead: '#ffffff',
                colorAccent: '#10b981',
                size: 1
            },
            coffee_machine: {
                id: 'coffee_machine',
                name: '–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞',
                cost: 800,
                desc: '-20% —Å—Ç—Ä–µ—Å—Å–∞ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤',
                renderType: 'appliance',
                effect: { stressReduction: 0.2 },
                size: 1
            },
            whiteboard: {
                id: 'whiteboard',
                name: '–ú–∞—Ä–∫–µ—Ä–Ω–∞—è –¥–æ—Å–∫–∞',
                cost: 300,
                desc: '+10% –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—Å—Ç—Ä–µ—á',
                renderType: 'board',
                effect: { meetingEfficiency: 1.1 },
                size: 1
            }
        };

        // ==================== –°–ò–°–¢–ï–ú–ê –ó–ê–î–ê–ù–ò–ô ====================
        const QUESTS = {
            intro: {
                id: 'intro',
                title: "–ü–µ—Ä–≤—ã–π —Ñ—Ä–∏–ª–∞–Ω—Å",
                description: "–ù–∞–ø–∏—à–∏ –ø—Ä–æ—Å—Ç–æ–π –ª–µ–Ω–¥–∏–Ω–≥ –¥–ª—è –ø–∏—Ü—Ü–µ—Ä–∏–∏. –ù—É–∂–Ω–æ 50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞.",
                type: "coding",
                requirement: { action: "click", amount: 50 },
                reward: { money: 300, xp: 100 },
                nextQuest: "first_hire",
                unlock: ["desk_wood", "office_chair"]
            },
            first_hire: {
                id: 'first_hire',
                title: "–†–∞—Å—à–∏—Ä—è–µ–º—Å—è",
                description: "–ù—É–∂–µ–Ω –ø–æ–º–æ—â–Ω–∏–∫! –ù–∞–Ω—è—Ç—å –ø–µ—Ä–≤–æ–≥–æ Junior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.",
                type: "hiring",
                requirement: { action: "buy", item: "employee_dev", amount: 1 },
                reward: { money: 500, xp: 250, item: "coffee_machine" },
                nextQuest: "server_setup",
                unlock: ["coffee_machine"]
            },
            server_setup: {
                id: 'server_setup',
                title: "–°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞",
                description: "–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –±—ç–∫–µ–Ω–¥. –£—Å—Ç–∞–Ω–æ–≤–∏ –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä.",
                type: "infrastructure",
                requirement: { action: "buy", item: "server_rack", amount: 1 },
                reward: { money: 1200, xp: 500, reputation: 10 },
                nextQuest: "bug_hunt"
            },
            bug_hunt: {
                id: 'bug_hunt',
                title: "–û—Ö–æ—Ç–∞ –Ω–∞ –±–∞–≥–∏",
                description: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ! –ù–∞–π–¥–∏ –∏ –∏—Å–ø—Ä–∞–≤—å 20 –±–∞–≥–æ–≤.",
                type: "coding",
                requirement: { action: "bug_fix", amount: 20 },
                reward: { money: 800, xp: 400, reputation: 15 },
                timeLimit: 180
            },
            team_management: {
                id: 'team_management',
                title: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π",
                description: "–ù–∞–Ω—è—Ç—å Team Lead –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏.",
                type: "hiring",
                requirement: { action: "buy", item: "employee_manager", amount: 1 },
                reward: { money: 2000, xp: 800, reputation: 25 },
                unlock: ["employee_manager"]
            }
        };

        const QuestSystem = {
            activeQuests: [],
            completedQuests: [],
            failedQuests: [],
            stats: {
                bugsFixed: 0,
                linesCoded: 0,
                projectsDelivered: 0,
                clientsSatisfied: 0,
                serversDeployed: 0
            },
            
            startQuest(questId) {
                const quest = QUESTS[questId];
                if (!quest || this.activeQuests.find(q => q.id === questId)) return;
                
                const activeQuest = {
                    ...quest,
                    startTime: Date.now(),
                    progress: { current: 0, total: quest.requirement.amount },
                    timer: quest.timeLimit || null
                };
                
                this.activeQuests.push(activeQuest);
                this.showQuestNotification(quest);
                updateQuestUI();
                
                if (quest.timeLimit) {
                    setTimeout(() => {
                        if (this.activeQuests.includes(activeQuest)) {
                            this.failQuest(questId);
                        }
                    }, quest.timeLimit * 1000);
                }
            },
            
            updateProgress(action, amount = 1, itemId = null) {
                this.activeQuests.forEach(quest => {
                    if (quest.requirement.action === action) {
                        if (action === 'buy' && itemId !== quest.requirement.item) return;
                        
                        quest.progress.current += amount;
                        this.checkCompletion(quest);
                        updateQuestUI();
                    }
                });
            },
            
            checkCompletion(quest) {
                if (quest.progress.current >= quest.progress.total) {
                    this.completeQuest(quest.id);
                }
            },
            
            completeQuest(questId) {
                const quest = QUESTS[questId];
                const activeIndex = this.activeQuests.findIndex(q => q.id === questId);
                
                if (activeIndex !== -1) {
                    // –ù–∞–≥—Ä–∞–¥–∞
                    GameState.tsp += quest.reward.money || 0;
                    GameState.xp = (GameState.xp || 0) + (quest.reward.xp || 0);
                    GameState.reputation += quest.reward.reputation || 0;
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                    if (quest.unlock) {
                        quest.unlock.forEach(itemId => {
                            UNLOCKED_ITEMS[itemId] = true;
                        });
                    }
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
                    if (quest.reward.item) {
                        GameState.tsp += ITEM_TYPES[quest.reward.item].cost * 0.5;
                        showNotification(`–ü–æ–ª—É—á–µ–Ω –±–æ–Ω—É—Å: ${ITEM_TYPES[quest.reward.item].name}!`, 'success');
                    }
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
                    this.completedQuests.push(questId);
                    this.activeQuests.splice(activeIndex, 1);
                    
                    // –°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ
                    if (quest.nextQuest && !this.activeQuests.find(q => q.id === quest.nextQuest)) {
                        setTimeout(() => this.startQuest(quest.nextQuest), 2000);
                    }
                    
                    this.showQuestComplete(quest);
                    updateQuestUI();
                    updateUI();
                    SaveSystem.save();
                }
            },
            
            failQuest(questId) {
                const activeIndex = this.activeQuests.findIndex(q => q.id === questId);
                if (activeIndex !== -1) {
                    this.failedQuests.push(questId);
                    this.activeQuests.splice(activeIndex, 1);
                    showNotification('–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–æ! –í—Ä–µ–º—è –≤—ã—à–ª–æ.', 'error');
                    updateQuestUI();
                }
            },
            
            showQuestNotification(quest) {
                showNotification(`–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ${quest.title}`, 'quest');
            },
            
            showQuestComplete(quest) {
                showNotification(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ${quest.title} (+$${quest.reward.money})`, 'success');
            }
        };

        // ==================== –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–´ ====================
        const WorkSystem = {
            findAvailableWorkstation() {
                return GameState.objects.find(obj => {
                    const itemType = ITEM_TYPES[obj.id];
                    return itemType && itemType.type === 'workstation' && 
                           !obj.isOccupied;
                });
            },
            
            assignToWorkstation(npc, workstation) {
                if (!workstation.isOccupied) {
                    npc.state = 'going_to_work';
                    npc.targetWorkstation = workstation;
                    npc.targetX = workstation.x + 0.5;
                    npc.targetY = workstation.y + 0.5;
                    workstation.isOccupied = true;
                    workstation.currentWorker = npc;
                    npc.currentWorkstation = workstation;
                    
                    console.log(`${npc.name} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ`);
                    return true;
                }
                return false;
            },
            
            releaseWorkstation(workstation) {
                if (workstation.currentWorker) {
                    const npc = workstation.currentWorker;
                    npc.state = 'idle';
                    npc.currentWorkstation = null;
                    npc.targetWorkstation = null;
                    workstation.currentWorker = null;
                    workstation.isOccupied = false;
                    console.log(`${npc.name} –æ—Å–≤–æ–±–æ–¥–∏–ª —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ`);
                }
            },
            
            updateWorkers() {
                GameState.npcs.forEach(npc => {
                    if (npc.state === 'idle') {
                        if (Math.random() < 0.05) {
                            const workstation = this.findAvailableWorkstation();
                            if (workstation) {
                                this.assignToWorkstation(npc, workstation);
                            } else {
                                npc.state = 'resting';
                                npc.targetX = npc.x + (Math.random() * 4 - 2);
                                npc.targetY = npc.y + (Math.random() * 4 - 2);
                            }
                        }
                    }
                    else if (npc.state === 'going_to_work') {
                        const dist = Math.sqrt(
                            Math.pow(npc.targetX - npc.x, 2) + 
                            Math.pow(npc.targetY - npc.y, 2)
                        );
                        
                        if (dist < 0.2 && npc.targetWorkstation) {
                            npc.state = 'working';
                            npc.x = npc.targetX;
                            npc.y = npc.targetY;
                            npc.rotation = 0;
                        }
                    }
                    else if (npc.state === 'working') {
                        npc.fatigue = Math.min(100, npc.fatigue + 0.1);
                        
                        if (npc.fatigue >= 80 && Math.random() < 0.01) {
                            this.releaseWorkstation(npc.currentWorkstation);
                            npc.state = 'resting';
                            npc.targetX = npc.x + (Math.random() * 3 - 1.5);
                            npc.targetY = npc.y + (Math.random() * 3 - 1.5);
                        }
                        
                        if (Math.random() < 0.001) {
                            this.releaseWorkstation(npc.currentWorkstation);
                            npc.state = 'resting';
                            npc.targetX = npc.x + (Math.random() * 4 - 2);
                            npc.targetY = npc.y + (Math.random() * 4 - 2);
                        }
                    }
                    else if (npc.state === 'resting') {
                        npc.fatigue = Math.max(0, npc.fatigue - 0.3);
                        
                        if (npc.fatigue <= 20 && Math.random() < 0.05) {
                            npc.state = 'idle';
                        }
                    }
                });
            },
            
            getWorkEfficiency(npc, workstation) {
                let efficiency = 1.0;
                
                if (npc.fatigue > 50) {
                    efficiency *= (1 - (npc.fatigue - 50) / 100);
                }
                
                return Math.max(0.1, efficiency);
            }
        };

        // ==================== –ò–ì–†–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ====================
        const GameState = {
            tsp: 100,
            clickPower: 1,
            autoClicker: 0,
            objects: [],
            npcs: [],
            gridSize: 12,
            xp: 0,
            reputation: 0,
            level: 1,
            lastNpcUpdate: Date.now(),
            techDebt: 0,
            bugs: []
        };

        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
        const UNLOCKED_ITEMS = {
            desk_wood: true,
            office_chair: true,
            pc_setup: true,
            plant: true,
            employee_dev: true,
            coffee_machine: true,
            employee_manager: true,
            server_rack: true,
            whiteboard: true
        };

        // ==================== –ì–†–ê–§–ò–ö–ê ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let camera = { x: 0, y: 0 };
        let drag = { active: false, x: 0, y: 0 };
        let particles = [];
        let bugEffects = [];
        let mousePos = { x: 0, y: 0 };
        let hoveredTile = null;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            camera.x = canvas.width / 2;
            camera.y = canvas.height / 3;
        }
        window.addEventListener('resize', resize);

        function toIso(gx, gy, z = 0) {
            return {
                x: (gx - gy) * CONFIG.tileSize + camera.x,
                y: (gx + gy) * (CONFIG.tileSize / 2) - (z * CONFIG.tileSize) + camera.y
            };
        }

        function screenToGrid(screenX, screenY) {
            const screenXAdjusted = screenX - camera.x;
            const screenYAdjusted = screenY - camera.y;
            
            const gx = (screenYAdjusted / (CONFIG.tileSize / 2) + screenXAdjusted / CONFIG.tileSize) / 2;
            const gy = (screenYAdjusted / (CONFIG.tileSize / 2) - screenXAdjusted / CONFIG.tileSize) / 2;
            
            return {
                x: Math.floor(gx),
                y: Math.floor(gy)
            };
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–ù–î–ï–† –ö–£–ë–ê ---
        function drawVoxel(gx, gy, z, w, d, h, color) {
            const ts = CONFIG.tileSize;
            const hPx = h * ts;

            const p0 = toIso(gx, gy, z);
            const p1 = toIso(gx + w, gy, z);
            const p2 = toIso(gx + w, gy + d, z);
            const p3 = toIso(gx, gy + d, z);

            ctx.lineJoin = 'round';
            ctx.lineWidth = 1;
            
            // –õ–µ–≤–∞—è –≥—Ä–∞–Ω—å
            const cLeft = shadeColor(color, -15);
            ctx.fillStyle = cLeft;
            ctx.strokeStyle = cLeft;
            ctx.beginPath();
            ctx.moveTo(p3.x, p3.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.lineTo(p2.x, p2.y - hPx);
            ctx.lineTo(p3.x, p3.y - hPx);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω—å
            const cRight = shadeColor(color, -30);
            ctx.fillStyle = cRight;
            ctx.strokeStyle = cRight;
            ctx.beginPath();
            ctx.moveTo(p2.x, p2.y);
            ctx.lineTo(p1.x, p1.y);
            ctx.lineTo(p1.x, p1.y - hPx);
            ctx.lineTo(p2.x, p2.y - hPx);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω—å
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            ctx.beginPath();
            ctx.moveTo(p0.x, p0.y - hPx);
            ctx.lineTo(p1.x, p1.y - hPx);
            ctx.lineTo(p2.x, p2.y - hPx);
            ctx.lineTo(p3.x, p3.y - hPx);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // –ë–ª–∏–∫
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(p0.x, p0.y - hPx);
            ctx.lineTo(p2.x, p2.y - hPx);
            ctx.stroke();
        }

        // --- –†–ï–ù–î–ï–†–ï–†–´ –û–ë–™–ï–ö–¢–û–í ---
        const Renderers = {
            chair: (obj, type) => {
                const c = type.colorPrimary;
                const legs = type.colorSecondary;
                
                drawVoxel(obj.x + 0.1, obj.y + 0.1, 0, 0.15, 0.15, 0.4, legs);
                drawVoxel(obj.x + 0.75, obj.y + 0.1, 0, 0.15, 0.15, 0.4, legs);
                drawVoxel(obj.x + 0.1, obj.y + 0.75, 0, 0.15, 0.15, 0.4, legs);
                drawVoxel(obj.x + 0.75, obj.y + 0.75, 0, 0.15, 0.15, 0.4, legs);
                drawVoxel(obj.x + 0.1, obj.y + 0.1, 0.4, 0.8, 0.8, 0.15, c);
                drawVoxel(obj.x + 0.1, obj.y + 0.1, 0.55, 0.15, 0.8, 0.6, shadeColor(c, 5));
            },
            desk: (obj, type) => {
                const c = type.colorPrimary;
                const dark = type.colorSecondary;
                drawVoxel(obj.x + 0.1, obj.y + 0.1, 0, 0.8, 0.1, 0.7, dark);
                drawVoxel(obj.x + 0.1, obj.y + 0.8, 0, 0.8, 0.1, 0.7, dark);
                drawVoxel(obj.x, obj.y, 0.7, 1, 1, 0.1, c);
            },
            pc: (obj, type) => {
                Renderers.desk(obj, ITEM_TYPES.desk_wood);
                
                const isOccupied = obj.isOccupied;
                const compColor = isOccupied ? '#22c55e' : type.colorSecondary;
                
                drawVoxel(obj.x + 0.5, obj.y + 0.3, 0.8, 0.1, 0.4, 0.1, '#333');
                
                const blink = isOccupied && Math.floor(Date.now() / 500) % 2 === 0;
                const screenColor = blink ? '#86efac' : compColor;
                
                drawVoxel(obj.x + 0.5, obj.y + 0.2, 0.9, 0.1, 0.6, 0.4, screenColor);
                drawVoxel(obj.x + 0.3, obj.y + 0.25, 0.8, 0.15, 0.5, 0.05, '#cbd5e1');
                
                const iso = toIso(obj.x + 0.5, obj.y + 0.5);
                ctx.fillStyle = isOccupied ? '#22c55e' : '#6b7280';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(isOccupied ? 'üíª –ó–∞–Ω—è—Ç–æ' : 'üÜì –°–≤–æ–±–æ–¥–Ω–æ', iso.x, iso.y + 40);
            },
            server: (obj, type) => {
                const c = type.colorPrimary;
                drawVoxel(obj.x + 0.1, obj.y + 0.1, 0, 0.8, 0.8, 1.5, c);
                
                const blink = Math.floor(Date.now() / 200) % 2 === 0;
                const lampColor = blink ? '#4ade80' : '#14532d';
                drawVoxel(obj.x + 0.9, obj.y + 0.2, 1.2, 0.05, 0.1, 0.1, lampColor);
                drawVoxel(obj.x + 0.9, obj.y + 0.4, 1.2, 0.05, 0.1, 0.1, lampColor);
            },
            plant: (obj, type) => {
                drawVoxel(obj.x + 0.3, obj.y + 0.3, 0, 0.4, 0.4, 0.4, type.colorSecondary);
                drawVoxel(obj.x + 0.45, obj.y + 0.45, 0.4, 0.1, 0.1, 0.4, type.colorPrimary);
                drawVoxel(obj.x + 0.25, obj.y + 0.25, 0.7, 0.5, 0.5, 0.4, shadeColor(type.colorPrimary, 10));
            },
            npc: (npc, type) => {
                const ts = CONFIG.tileSize;
                const iso = toIso(npc.x, npc.y);
                
                let stateColor = type.colorBody;
                let stateIndicator = '';
                
                switch(npc.state) {
                    case 'working':
                        stateColor = shadeColor(type.colorBody, 20);
                        stateIndicator = 'üíª';
                        break;
                    case 'going_to_work':
                        stateColor = shadeColor(type.colorBody, 10);
                        stateIndicator = 'üö∂‚Äç‚ôÇÔ∏è';
                        break;
                    case 'resting':
                        stateColor = shadeColor(type.colorBody, -20);
                        stateIndicator = '‚òï';
                        break;
                    default:
                        stateIndicator = 'üîÑ';
                }
                
                let walkOffset = 0;
                let heightOffset = 0;
                
                if (npc.state === 'working') {
                    walkOffset = Math.sin(npc.frame * 0.8) * 2;
                    heightOffset = 0.5 + Math.sin(npc.frame * 1.5) * 0.05;
                    
                } else if (npc.state !== 'working') {
                    walkOffset = Math.sin(npc.frame * 0.5) * 3;
                    heightOffset = 0.5 + Math.abs(Math.sin(npc.frame * 0.5)) * 0.1;
                }
                
                // --- –ù–û–ì–ò ---
                if (npc.state !== 'working') {
                    const legOffset = walkOffset;
                    drawVoxel(
                        npc.x + 0.25, 
                        npc.y + 0.35, 
                        0.1, 
                        0.2, 0.3, 0.5 + (legOffset > 0 ? legOffset * 0.05 : 0), 
                        stateColor
                    );
                    drawVoxel(
                        npc.x + 0.55, 
                        npc.y + 0.35, 
                        0.1, 
                        0.2, 0.3, 0.5 + (legOffset < 0 ? -legOffset * 0.05 : 0), 
                        stateColor
                    );
                } else {
                    drawVoxel(npc.x + 0.35, npc.y + 0.4, 0.1, 0.3, 0.4, 0.4, stateColor);
                }
                
                // --- –¢–ï–õ–û ---
                drawVoxel(
                    npc.x + 0.25, 
                    npc.y + 0.25, 
                    0.6 + heightOffset * 0.1, 
                    0.5, 0.5, 0.6, 
                    shadeColor(stateColor, -10)
                );
                
                // --- –ì–û–õ–û–í–ê ---
                drawVoxel(
                    npc.x + 0.35, 
                    npc.y + 0.35, 
                    1.2 + heightOffset * 0.1, 
                    0.3, 0.3, 0.3, 
                    type.colorHead
                );
                
                // --- –ò–ù–î–ò–ö–ê–¢–û–† –°–û–°–¢–û–Ø–ù–ò–Ø ---
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stateIndicator, iso.x, iso.y - ts * 2.2);
                
                // --- –ò–ú–Ø ---
                ctx.font = 'bold 10px Arial';
                ctx.fillText(
                    type.name.split(' ')[0], 
                    iso.x, 
                    iso.y - ts * 1.8
                );
                
                // --- –ü–û–õ–û–°–ö–ê –£–°–¢–ê–õ–û–°–¢–ò ---
                if (npc.fatigue > 30) {
                    const barWidth = 30;
                    const barHeight = 4;
                    const fatiguePercent = npc.fatigue / 100;
                    
                    ctx.fillStyle = '#374151';
                    ctx.fillRect(iso.x - barWidth/2, iso.y - ts * 1.6, barWidth, barHeight);
                    
                    const r = Math.min(255, Math.floor(255 * fatiguePercent));
                    const g = Math.max(0, Math.floor(255 * (1 - fatiguePercent)));
                    ctx.fillStyle = `rgb(${r}, ${g}, 0)`;
                    ctx.fillRect(iso.x - barWidth/2, iso.y - ts * 1.6, barWidth * fatiguePercent, barHeight);
                }
                
                // --- –î–ï–¢–ê–õ–ò ---
                if (npc.id === 'employee_dev' && npc.state === 'working') {
                    drawVoxel(
                        npc.x + 0.6, 
                        npc.y + 0.25, 
                        0.9 + heightOffset * 0.1, 
                        0.25, 0.4, 0.15, 
                        '#94a3b8'
                    );
                }
                
                if (npc.id === 'employee_manager' && npc.state === 'working') {
                    drawVoxel(
                        npc.x + 0.1, 
                        npc.y + 0.25, 
                        0.9 + heightOffset * 0.1, 
                        0.2, 0.3, 0.05, 
                        type.colorAccent
                    );
                }
            },
            appliance: (obj, type) => {
                drawVoxel(obj.x + 0.2, obj.y + 0.2, 0, 0.6, 0.6, 0.8, '#4b5563');
                drawVoxel(obj.x + 0.3, obj.y + 0.3, 0.8, 0.4, 0.4, 0.2, '#d1d5db');
                
                const coffeeTime = Date.now() / 1000;
                if (Math.sin(coffeeTime * 2) > 0.7) {
                    drawVoxel(obj.x + 0.35, obj.y + 0.35, 1.0, 0.1, 0.1, 0.1, '#78350f');
                }
            },
            board: (obj, type) => {
                drawVoxel(obj.x, obj.y, 0, 1, 0.1, 1.5, '#f8fafc');
                
                const iso = toIso(obj.x + 0.5, obj.y + 0.05, 1.0);
                ctx.fillStyle = '#0f172a';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('TODO:', iso.x, iso.y);
                ctx.font = '10px Arial';
                ctx.fillText('‚Ä¢ Fix bugs', iso.x, iso.y + 15);
                ctx.fillText('‚Ä¢ Deploy', iso.x, iso.y + 30);
            }
        };

        // ==================== –°–ò–°–¢–ï–ú–ê NPC ====================
        function updateNPCs() {
            const now = Date.now();
            const delta = Math.min((now - GameState.lastNpcUpdate) / 16, 2);
            
            WorkSystem.updateWorkers();
            
            GameState.npcs.forEach(npc => {
                npc.frame += delta * npc.speed * 10;
                
                if (npc.state !== 'working') {
                    const dist = Math.sqrt(
                        Math.pow(npc.targetX - npc.x, 2) + 
                        Math.pow(npc.targetY - npc.y, 2)
                    );
                    
                    if (dist < 0.1 || Math.random() < 0.01) {
                        if (npc.state === 'idle' || npc.state === 'resting') {
                            npc.targetX = 1 + Math.random() * (GameState.gridSize - 3);
                            npc.targetY = 1 + Math.random() * (GameState.gridSize - 3);
                        }
                    }
                    
                    const angle = Math.atan2(npc.targetY - npc.y, npc.targetX - npc.x);
                    npc.x += Math.cos(angle) * npc.speed * delta;
                    npc.y += Math.sin(angle) * npc.speed * delta;
                    
                    npc.x = Math.max(1, Math.min(GameState.gridSize - 2, npc.x));
                    npc.y = Math.max(1, Math.min(GameState.gridSize - 2, npc.y));
                }
            });
            
            GameState.lastNpcUpdate = now;
        }

        // ==================== –í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–§–§–ï–ö–¢–´ ====================
        function createCodeParticles(x, y, type) {
            const colors = type === 'dev' ? 
                ['#3b82f6', '#60a5fa', '#93c5fd'] : 
                ['#8b5cf6', '#a78bfa', '#c4b5fd'];
            
            const symbols = {
                dev: ['{', '}', '(', ')', ';', '=', '[', ']', '<', '>'],
                manager: ['üìä', 'üìà', 'üìã', 'üéØ', '‚úÖ', '‚ùå']
            };
            
            for (let i = 0; i < 4; i++) {
                particles.push({
                    x: x + Math.random() * 15 - 7.5,
                    y: y - Math.random() * 20,
                    vx: (Math.random() - 0.5) * 1.2,
                    vy: -1.2 - Math.random() * 1.5,
                    life: 0.8 + Math.random() * 0.4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    char: symbols[type][Math.floor(Math.random() * symbols[type].length)],
                    size: 10 + Math.random() * 6
                });
            }
        }

        function createBugEffect(x, y, severity) {
            bugEffects.push({
                x, y,
                severity,
                particles: Array.from({length: 6}, (_, i) => ({
                    angle: (i / 6) * Math.PI * 2,
                    distance: 0,
                    maxDistance: severity === 'critical' ? 30 : 20,
                    speed: severity === 'critical' ? 2 : 1.5
                })),
                color: severity === 'critical' ? '#ef4444' : '#f59e0b',
                life: 1
            });
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vy += 0.05;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            for (let i = bugEffects.length - 1; i >= 0; i--) {
                const bug = bugEffects[i];
                bug.life -= 0.01;
                
                for (const particle of bug.particles) {
                    particle.distance = Math.min(particle.distance + particle.speed, particle.maxDistance);
                }
                
                if (bug.life <= 0) {
                    bugEffects.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.font = `bold ${p.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(p.char, p.x, p.y);
                ctx.restore();
            });
            
            bugEffects.forEach(bug => {
                const iso = toIso(bug.x, bug.y);
                bug.particles.forEach(particle => {
                    const px = iso.x + Math.cos(particle.angle) * particle.distance;
                    const py = iso.y + Math.sin(particle.angle) * particle.distance;
                    
                    ctx.save();
                    ctx.globalAlpha = bug.life;
                    ctx.fillStyle = bug.color;
                    ctx.beginPath();
                    ctx.arc(px, py, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            });
        }

        // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ë–ê–ì–û–í ====================
        function generateBug() {
            if (GameState.techDebt > 30 && Math.random() < 0.005) {
                const severity = GameState.techDebt > 70 ? 'critical' : 
                                GameState.techDebt > 40 ? 'medium' : 'low';
                
                const bug = {
                    id: Date.now(),
                    x: 1 + Math.random() * (GameState.gridSize - 2),
                    y: 1 + Math.random() * (GameState.gridSize - 2),
                    severity,
                    reward: severity === 'critical' ? 50 : 
                           severity === 'medium' ? 25 : 10,
                    fixTime: severity === 'critical' ? 10 : 5
                };
                
                GameState.bugs.push(bug);
                createBugEffect(bug.x, bug.y, severity);
                
                showNotification(`üêõ –ù–æ–≤—ã–π –±–∞–≥! ${severity === 'critical' ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π!' : ''}`, 'error');
                updateTechDebtUI();
            }
        }

        function fixBug(bugId) {
            const bugIndex = GameState.bugs.findIndex(b => b.id === bugId);
            if (bugIndex !== -1) {
                const bug = GameState.bugs[bugIndex];
                GameState.tsp += bug.reward;
                GameState.techDebt = Math.max(0, GameState.techDebt - (bug.severity === 'critical' ? 10 : 5));
                QuestSystem.updateProgress('bug_fix', 1);
                GameState.bugs.splice(bugIndex, 1);
                updateUI();
                updateTechDebtUI();
                spawnFloatingText(`+$${bug.reward}`, 
                    toIso(bug.x, bug.y).x + camera.x, 
                    toIso(bug.x, bug.y).y + camera.y, 
                    '#22c55e');
            }
        }

        // ==================== –û–°–ù–û–í–ù–û–ô –†–ï–ù–î–ï–† ====================
        function drawGrid() {
            for (let i = 0; i < GameState.gridSize; i++) {
                for (let j = 0; j < GameState.gridSize; j++) {
                    const iso = toIso(i, j);
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                    let isHovered = hoveredTile && hoveredTile.x === i && hoveredTile.y === j;
                    
                    ctx.beginPath();
                    ctx.moveTo(iso.x, iso.y);
                    ctx.lineTo(iso.x + CONFIG.tileSize, iso.y + CONFIG.tileSize / 2);
                    ctx.lineTo(iso.x, iso.y + CONFIG.tileSize);
                    ctx.lineTo(iso.x - CONFIG.tileSize, iso.y + CONFIG.tileSize / 2);
                    ctx.closePath();

                    if (isHovered) {
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                    } else {
                        ctx.fillStyle = (i + j) % 2 === 0 ? CONFIG.colors.floor : CONFIG.colors.floorHighlight;
                    }
                    
                    ctx.fill();
                    ctx.strokeStyle = isHovered ? '#3b82f6' : '#334155';
                    ctx.lineWidth = isHovered ? 2 : 0.5;
                    ctx.stroke();
                }
            }
        }

        function drawObjects() {
            // –ë–∞–≥–∏
            GameState.bugs.forEach(bug => {
                const iso = toIso(bug.x, bug.y, 0.1);
                ctx.save();
                ctx.globalAlpha = 0.7;
                ctx.fillStyle = bug.severity === 'critical' ? '#ef4444' : 
                               bug.severity === 'medium' ? '#f59e0b' : '#6b7280';
                ctx.beginPath();
                ctx.arc(iso.x, iso.y, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üêõ', iso.x, iso.y + 3);
                ctx.restore();
            });
            
            // –í—Å–µ –æ–±—ä–µ–∫—Ç—ã
            const allObjects = [
                ...GameState.objects.map(obj => ({...obj, type: 'object'})),
                ...GameState.npcs.map(npc => ({...npc, type: 'npc'}))
            ];
            
            allObjects.sort((a, b) => (a.x + a.y) - (b.x + b.y));
            
            allObjects.forEach(item => {
                const iso = toIso(item.x, item.y);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(iso.x, iso.y + CONFIG.tileSize/2, CONFIG.tileSize/2.5, CONFIG.tileSize/4, 0, 0, Math.PI*2);
                ctx.fill();
                
                if (item.type === 'npc') {
                    Renderers.npc(item, ITEM_TYPES[item.id]);
                } else {
                    const type = ITEM_TYPES[item.id];
                    if (Renderers[type.renderType]) {
                        Renderers[type.renderType](item, type);
                    }
                }
            });
        }

        function render() {
            const gradient = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, 100,
                canvas.width/2, canvas.height/2, 800
            );
            gradient.addColorStop(0, '#1e293b');
            gradient.addColorStop(1, '#020617');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawGrid();
            drawObjects();
            drawParticles();
            
            // –ü—Ä–µ–≤—å—é —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            PlacementSystem.drawPreview();
            
            requestAnimationFrame(render);
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ ====================
        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1,3),16);
            let G = parseInt(color.substring(3,5),16);
            let B = parseInt(color.substring(5,7),16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R<255)?R:255;  G = (G<255)?G:255;  B = (B<255)?B:255;  
            if (R < 0) R = 0; if (G < 0) G = 0; if (B < 0) B = 0;

            const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }

        function spawnFloatingText(text, x, y, color = '#4ade80') {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.color = color;
            el.style.left = (x - 20) + 'px';
            el.style.top = (y - 50) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showNotification(text, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'quest-notification';
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'quest') icon = 'üéØ';
            
            notification.innerHTML = `
                <div class="quest-header">
                    <span class="quest-icon">${icon}</span>
                    <span class="quest-title">${text}</span>
                </div>
            `;
            
            const container = document.getElementById('notification-center');
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== UI –§–£–ù–ö–¶–ò–ò ====================
        function updateUI() {
            document.getElementById('score-tsp').textContent = Math.floor(GameState.tsp);
            
            let incomePerSec = 0;
            GameState.objects.forEach(obj => {
                const item = ITEM_TYPES[obj.id];
                if (item.income) {
                    incomePerSec += item.income;
                }
            });
            
            GameState.npcs.forEach(npc => {
                if (npc.state === 'working' && npc.currentWorkstation) {
                    const baseIncome = npc.id === 'employee_dev' ? 30 : 60;
                    const efficiency = WorkSystem.getWorkEfficiency(npc, npc.currentWorkstation);
                    incomePerSec += baseIncome * efficiency;
                }
            });
            
            document.getElementById('income-per-sec').textContent = Math.floor(incomePerSec) + '/—Å–µ–∫';
            document.getElementById('reputation').textContent = GameState.reputation;
            document.getElementById('player-level').textContent = GameState.level;
            document.getElementById('player-xp').textContent = GameState.xp;
            renderShop();
        }

        function updateQuestUI() {
            const activeContainer = document.getElementById('active-quests');
            const availableContainer = document.getElementById('available-quests');
            
            activeContainer.innerHTML = '';
            availableContainer.innerHTML = '';
            
            QuestSystem.activeQuests.forEach(quest => {
                const el = document.createElement('div');
                el.className = 'quest-notification';
                const progress = Math.min(100, (quest.progress.current / quest.progress.total) * 100);
                
                let timerHTML = '';
                if (quest.timer) {
                    const elapsed = Math.floor((Date.now() - quest.startTime) / 1000);
                    const remaining = Math.max(0, quest.timer - elapsed);
                    timerHTML = `<div class="quest-timer">${remaining}—Å –æ—Å—Ç–∞–ª–æ—Å—å</div>`;
                }
                
                el.innerHTML = `
                    <div class="quest-header">
                        <span class="quest-icon">üéØ</span>
                        <span class="quest-title">${quest.title}</span>
                    </div>
                    <div class="quest-desc">${quest.description}</div>
                    <div class="mt-2">
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-xs text-slate-400 mt-1">${quest.progress.current}/${quest.progress.total}</div>
                    </div>
                    ${timerHTML}
                `;
                activeContainer.appendChild(el);
            });
            
            Object.values(QUESTS).forEach(quest => {
                if (!QuestSystem.activeQuests.find(q => q.id === quest.id) && 
                    !QuestSystem.completedQuests.includes(quest.id) &&
                    !QuestSystem.failedQuests.includes(quest.id)) {
                    
                    const canStart = true;
                    
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-lg border ${canStart ? 'border-blue-500 bg-slate-800/50' : 'border-slate-700 bg-slate-800/30'}`;
                    el.innerHTML = `
                        <div class="text-white font-bold text-sm mb-1">${quest.title}</div>
                        <div class="text-xs text-slate-400 mb-2">${quest.description}</div>
                        <div class="text-xs text-green-400 mb-2">–ù–∞–≥—Ä–∞–¥–∞: $${quest.reward.money} ‚≠ê${quest.reward.xp}</div>
                        <button onclick="startQuest('${quest.id}')" 
                                class="w-full py-2 rounded-lg text-sm font-bold ${canStart ? 'bg-blue-600 hover:bg-blue-500' : 'bg-slate-700 cursor-not-allowed'}">
                            –ù–∞—á–∞—Ç—å
                        </button>
                    `;
                    availableContainer.appendChild(el);
                }
            });
        }

        function updateTechDebtUI() {
            const debtBar = document.getElementById('tech-debt-bar');
            const debtFill = document.getElementById('tech-debt-fill');
            const debtValue = document.getElementById('debt-value');
            
            if (GameState.techDebt > 0) {
                debtBar.classList.remove('hidden');
                debtFill.style.width = `${GameState.techDebt}%`;
                debtValue.textContent = Math.floor(GameState.techDebt);
                
                if (GameState.techDebt > 70) {
                    debtFill.classList.add('animate-pulse');
                } else {
                    debtFill.classList.remove('animate-pulse');
                }
            } else {
                debtBar.classList.add('hidden');
            }
        }

        function buyItem(itemId) {
            const item = ITEM_TYPES[itemId];
            
            if (!UNLOCKED_ITEMS[itemId]) {
                showNotification(`üîí –ü—Ä–µ–¥–º–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è!`, 'error');
                return;
            }
            
            if (GameState.tsp >= item.cost) {
                // –î–ª—è NPC - —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º
                if (item.renderType === 'npc') {
                    GameState.tsp -= item.cost;
                    
                    const spawnX = 1 + Math.random() * (GameState.gridSize - 3);
                    const spawnY = 1 + Math.random() * (GameState.gridSize - 3);
                    
                    GameState.npcs.push({
                        ...item,
                        x: spawnX,
                        y: spawnY,
                        targetX: spawnX + (Math.random() * 4 - 2),
                        targetY: spawnY + (Math.random() * 4 - 2),
                        dir: 0,
                        frame: Math.random() * 100,
                        state: 'idle',
                        currentWorkstation: null,
                        workEfficiency: 1.0,
                        fatigue: 0
                    });
                    
                    GameState.techDebt += 5;
                    
                    spawnFloatingText(`+${item.income}/—Å–µ–∫`, 
                        toIso(spawnX, spawnY).x + camera.x, 
                        toIso(spawnX, spawnY).y + camera.y, 
                        '#3b82f6');
                    
                    QuestSystem.updateProgress('buy', 1, item.id);
                    GameState.techDebt = Math.min(100, GameState.techDebt + 2);
                    updateUI();
                    updateTechDebtUI();
                    SaveSystem.save();
                    
                    showNotification(`${item.name} –Ω–∞–Ω—è—Ç!`, 'success');
                } 
                // –î–ª—è –º–µ–±–µ–ª–∏ - –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                else {
                    PlacementSystem.startPlacement(itemId);
                }
            } else {
                showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ $${item.cost}`, 'error');
            }
        }

        function renderShop() {
            const list = document.getElementById('shop-items');
            list.innerHTML = '';
            Object.values(ITEM_TYPES).forEach(item => {
                const canBuy = GameState.tsp >= item.cost;
                const isUnlocked = UNLOCKED_ITEMS[item.id];
                
                const el = document.createElement('div');
                el.className = `p-3 rounded-xl border flex justify-between items-center transition-all hover-glow ${isUnlocked ? (canBuy ? 'bg-slate-800 border-slate-600 hover:border-blue-500' : 'bg-slate-800/50 border-slate-800 opacity-50') : 'bg-slate-900/30 border-slate-800 opacity-30'}`;
                
                let unlockText = '';
                if (!isUnlocked) {
                    unlockText = '<div class="text-xs text-amber-500 mb-1">üîí –ó–∞–¥–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>';
                }
                
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg" style="background: ${item.colorPrimary || '#475569'}"></div>
                        <div>
                            ${unlockText}
                            <div class="text-white font-bold text-sm">${item.name}</div>
                            <div class="text-xs ${item.renderType === 'npc' ? 'text-blue-300' : 'text-slate-400'}">${item.desc}</div>
                            ${item.income > 0 ? `<div class="text-xs text-green-400 mt-1">+${item.income} –∫–æ–¥/—Å–µ–∫</div>` : ''}
                        </div>
                    </div>
                    <button class="px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-transform active:scale-95 ${isUnlocked && canBuy ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}"
                            onclick="${isUnlocked && canBuy ? `buyItem('${item.id}')` : ''}">
                        $${item.cost}
                    </button>
                `;
                list.appendChild(el);
            });
        }

        // ==================== –°–û–ë–´–¢–ò–Ø ====================
        document.getElementById('work-btn').addEventListener('click', (e) => {
            GameState.tsp += GameState.clickPower;
            GameState.techDebt = Math.min(100, GameState.techDebt + 0.5);
            QuestSystem.updateProgress('click', 1);
            spawnFloatingText("+$" + GameState.clickPower, e.clientX, e.clientY);
            
            updateUI();
            updateTechDebtUI();
            if (navigator.vibrate) navigator.vibrate(10);
        });

        document.getElementById('assign-workers').addEventListener('click', () => {
            let assigned = 0;
            GameState.npcs.forEach(npc => {
                if (npc.state === 'idle') {
                    const workstation = WorkSystem.findAvailableWorkstation();
                    if (workstation) {
                        WorkSystem.assignToWorkstation(npc, workstation);
                        assigned++;
                    }
                }
            });
            
            if (assigned > 0) {
                showNotification(`–ù–∞–∑–Ω–∞—á–µ–Ω–æ ${assigned} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Ä–∞–±–æ—á–∏–µ –º–µ—Å—Ç–∞`, 'success');
            } else {
                showNotification('–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', 'info');
            }
        });

        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        document.getElementById('save-game').addEventListener('click', () => {
            SaveSystem.save();
        });

        const shopPanel = document.getElementById('shop-panel');
        document.getElementById('shop-toggle').addEventListener('click', () => {
            shopPanel.classList.toggle('hidden');
            if (!shopPanel.classList.contains('hidden')) {
                renderShop();
            }
        });
        document.getElementById('close-shop').addEventListener('click', () => shopPanel.classList.add('hidden'));

        const questPanel = document.getElementById('quest-panel');
        document.getElementById('quest-toggle').addEventListener('click', () => {
            questPanel.classList.toggle('hidden');
            updateQuestUI();
        });

        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        document.getElementById('cancel-placement').addEventListener('click', () => {
            PlacementSystem.cancelPlacement();
        });

        // –ö–∞–º–µ—Ä–∞
        canvas.addEventListener('mousedown', (e) => { 
            if (!PlacementSystem.isPlacing && e.button === 0) {
                drag.active = true; 
                drag.x = e.clientX; 
                drag.y = e.clientY; 
            }
        });
        
        window.addEventListener('mouseup', () => drag.active = false);
        
        window.addEventListener('mousemove', (e) => {
            if (drag.active) {
                camera.x += e.clientX - drag.x;
                camera.y += e.clientY - drag.y;
                drag.x = e.clientX;
                drag.y = e.clientY;
            }
            
            if (PlacementSystem.isPlacing) {
                const rect = canvas.getBoundingClientRect();
                const gridPos = screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
                PlacementSystem.updatePreview(gridPos.x, gridPos.y);
            }
            
            const rect = canvas.getBoundingClientRect();
            const gridPos = screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
            
            if (gridPos.x >= 0 && gridPos.x < GameState.gridSize && 
                gridPos.y >= 0 && gridPos.y < GameState.gridSize) {
                hoveredTile = gridPos;
            } else {
                hoveredTile = null;
            }
            
            mousePos.x = e.clientX - rect.left;
            mousePos.y = e.clientY - rect.top;
        });

        // –ö–ª–∏–∫ –ø–æ —Å–µ—Ç–∫–µ
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const gridPos = screenToGrid(e.clientX - rect.left, e.clientY - rect.top);
            
            if (PlacementSystem.isPlacing) {
                e.preventDefault();
                PlacementSystem.placeObject(gridPos.x, gridPos.y);
                return;
            }
            
            const bugsToRemove = [];
            
            GameState.bugs.forEach(bug => {
                const bugIso = toIso(bug.x, bug.y);
                const bugScreenX = bugIso.x;
                const bugScreenY = bugIso.y;
                
                const left = bugScreenX - 20;
                const right = bugScreenX + 20;
                const top = bugScreenY - 20;
                const bottom = bugScreenY + 20;
                
                if (mousePos.x >= left && mousePos.x <= right && 
                    mousePos.y >= top && mousePos.y <= bottom) {
                    bugsToRemove.push(bug.id);
                }
            });
            
            bugsToRemove.forEach(bugId => fixBug(bugId));
        });

        // –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (PlacementSystem.isPlacing) {
                PlacementSystem.cancelPlacement();
            }
        });

        // –ö–ª–∞–≤–∏—à–∞ ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && PlacementSystem.isPlacing) {
                PlacementSystem.cancelPlacement();
            }
            
            if (e.key === 's' && e.ctrlKey) {
                e.preventDefault();
                SaveSystem.save();
            }
            if (e.key === 'd' && e.ctrlKey) {
                e.preventDefault();
                SaveSystem.delete();
            }
        });

        // ==================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
        // –ó–∞–ø—É—Å–∫–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', () => {
            LoadingSystem.init();
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.buyItem = buyItem;
        window.startQuest = (questId) => QuestSystem.startQuest(questId);
        window.fixBug = fixBug;
        window.saveGame = () => SaveSystem.save();
        window.loadGame = () => SaveSystem.load();
        window.exportSave = () => SaveSystem.exportSave();
        window.importSave = () => SaveSystem.importSave();

    </script>
</body>
</html>

 updateWorkers